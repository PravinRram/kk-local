{% extends "_includes/karaoke-base.html" %} {% block title %}My Profile{%
endblock %} {% block content %}

<div class="container py-4">
  <!-- Profile Header -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <div class="card profile-header">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <div class="d-flex align-items-center">
                <div class="profile-avatar" id="profileAvatar">
                  {{ g.user.display_name[:1].upper() }}
                </div>
                <div class="ms-4">
                  <h2 class="mb-0">
                    {{ g.user.display_name }}
                  </h2>
                  <p class="text-muted mb-0">
                    Member since {{ g.user.created_at.strftime('%d %b %Y') }}
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <button
                class="btn btn-outline-primary me-2"
                data-bs-toggle="modal"
                data-bs-target="#editProfileModal"
              >
                <i data-feather="edit-2" class="me-1"></i> Edit Profile
              </button>
              <button
                class="btn btn-primary"
                id="shareProfileBtn"
              >
                <i data-feather="share-2" class="me-1"></i>
                Share
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="row mb-4">
    <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
      <div class="card h-100 dashboard-card">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="card-title">Statistics</h5>
            <i data-feather="bar-chart-2" class="text-primary"></i>
          </div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="totalSessions">0</div>
              <div class="stat-label">Sessions</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="totalSongs">0</div>
              <div class="stat-label">Songs</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="highestScore">0</div>
              <div class="stat-label">Best Score</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="averageScore">0</div>
              <div class="stat-label">Avg Score</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="ranking">-</div>
              <div class="stat-label">Ranking</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="improvementRate">
                0%
              </div>
              <div class="stat-label">Improvement</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
      <div class="card h-100 dashboard-card">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="card-title">Your Skills</h5>
            <i data-feather="activity" class="text-primary"></i>
          </div>
          <div class="skill-container mb-3">
            <div class="d-flex justify-content-between">
              <span>Pitch Accuracy</span>
              <span id="pitchAccuracy">0%</span>
            </div>
            <div class="progress" style="height: 8px">
              <div
                id="pitchAccuracyBar"
                class="progress-bar bg-primary"
                style="width: 0%"
              >
              </div>
            </div>
          </div>
          <div class="skill-container mb-3">
            <div class="d-flex justify-content-between">
              <span>Rhythm & Timing</span>
              <span id="rhythmAccuracy">0%</span>
            </div>
            <div class="progress" style="height: 8px">
              <div
                id="rhythmAccuracyBar"
                class="progress-bar bg-success"
                style="width: 0%"
              >
              </div>
            </div>
          </div>
          <div class="skill-container mb-3">
            <div class="d-flex justify-content-between">
              <span>Vocal Range</span>
              <span id="vocalRange">0%</span>
            </div>
            <div class="progress" style="height: 8px">
              <div
                id="vocalRangeBar"
                class="progress-bar bg-warning"
                style="width: 0%"
              >
              </div>
            </div>
          </div>
          <div class="skill-container">
            <div class="d-flex justify-content-between">
              <span>Song Completion</span>
              <span id="songCompletion">0%</span>
            </div>
            <div class="progress" style="height: 8px">
              <div
                id="songCompletionBar"
                class="progress-bar bg-info"
                style="width: 0%"
              >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-md-12">
      <div class="card h-100 dashboard-card">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="card-title">Favorite Genres</h5>
            <i data-feather="disc" class="text-primary"></i>
          </div>
          <div id="genresContainer" class="genres-container">
            <div class="text-center py-5">
              <div
                class="spinner-border text-primary"
                role="status"
              >
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Chart -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <div class="card dashboard-card">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="card-title">Performance History</h5>
            <div class="chart-filters">
              <button
                class="btn btn-sm btn-outline-secondary active"
                data-period="7"
              >
                7 Days
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                data-period="30"
              >
                30 Days
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                data-period="90"
              >
                90 Days
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                data-period="all"
              >
                All Time
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="performanceChart" height="300"></canvas>
            <div
              id="noDataMessage"
              class="text-center p-5"
              style="display: none"
            >
              <p class="text-muted">
                No performance data available for this period.
              </p>
              <a
                href="{{ url_for('karaoke_create') }}"
                class="btn btn-primary"
              >Start Singing Now</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity and Recommendations -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card dashboard-card h-100">
        <div class="card-body">
          <div
            class="d-flex justify-content-between align-items-center mb-3"
          >
            <h5 class="card-title">Recent Activity</h5>
            <a
              href="{{ url_for('scores_my_scores') }}"
              class="text-decoration-none"
            >View All</a>
          </div>
          <div id="recentActivityContainer">
            <div class="text-center py-3">
              <div
                class="spinner-border text-primary"
                role="status"
              >
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card dashboard-card h-100">
        <div class="card-body">
          <div
            class="d-flex justify-content-between align-items-center mb-3"
          >
            <h5 class="card-title">Recommended Songs</h5>
            <span class="badge bg-primary">Personalized</span>
          </div>
          <div id="recommendationsContainer">
            <div class="text-center py-3">
              <div
                class="spinner-border text-primary"
                role="status"
              >
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements Section -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <div class="card dashboard-card">
        <div class="card-body">
          <div
            class="d-flex justify-content-between align-items-center mb-4"
          >
            <h5 class="card-title">Achievements</h5>
            <button
              class="btn btn-sm btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#achievementsModal"
            >
              View All
            </button>
          </div>
          <div
            class="achievements-container"
            id="achievementsContainer"
          >
            <!-- Achievement items will be loaded dynamically -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div
  class="modal fade"
  id="editProfileModal"
  tabindex="-1"
  aria-labelledby="editProfileModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">
          Edit Profile
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
        </button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="mb-3">
            <label for="displayName" class="form-label">Display Name</label>
            <input
              type="text"
              class="form-control"
              id="displayName"
              value="{{ g.user.display_name }}"
              required
              minlength="3"
              maxlength="30"
            />
            <div class="form-text">
              This name will be visible to other users
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Profile Color</label>
            <div class="color-picker">
              <div
                class="color-option"
                data-color="var(--primary-color)"
                style="background-color: var(--primary-color)"
              >
              </div>
              <div
                class="color-option"
                data-color="var(--secondary-color)"
                style="background-color: var(--secondary-color)"
              >
              </div>
              <div
                class="color-option"
                data-color="#4f46e5"
                style="background-color: #4f46e5"
              >
              </div>
              <div
                class="color-option"
                data-color="#0ea5e9"
                style="background-color: #0ea5e9"
              >
              </div>
              <div
                class="color-option"
                data-color="#22c55e"
                style="background-color: #22c55e"
              >
              </div>
              <div
                class="color-option"
                data-color="#ef4444"
                style="background-color: #ef4444"
              >
              </div>
              <div
                class="color-option"
                data-color="#8b5cf6"
                style="background-color: #8b5cf6"
              >
              </div>
              <div
                class="color-option"
                data-color="#ec4899"
                style="background-color: #ec4899"
              >
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Notification Preferences</label>
            <div class="form-check form-switch mb-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="notifyNewSongs"
                checked
              />
              <label class="form-check-label" for="notifyNewSongs"
              >New songs added</label>
            </div>
            <div class="form-check form-switch mb-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="notifyLeaderboard"
                checked
              />
              <label
                class="form-check-label"
                for="notifyLeaderboard"
              >Leaderboard changes</label>
            </div>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="notifyFriendActivity"
                checked
              />
              <label
                class="form-check-label"
                for="notifyFriendActivity"
              >Friend activity</label>
            </div>
          </div>
          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="publicProfile"
              checked
            />
            <label class="form-check-label" for="publicProfile">
              Make my profile public
            </label>
            <div class="form-text">
              Your scores and achievements will be visible on leaderboards
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          id="saveProfileBtn"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Achievements Modal -->
<div
  class="modal fade"
  id="achievementsModal"
  tabindex="-1"
  aria-labelledby="achievementsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="achievementsModalLabel">
          Your Achievements
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
        </button>
      </div>
      <div class="modal-body">
        <div class="achievements-grid" id="allAchievementsContainer">
          <!-- All achievements will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block styles %} {{ super() }}
<style>
  /* Profile styles */
  .profile-header {
    border-radius: 15px;
    background: linear-gradient(
      135deg,
      rgba(240, 107, 66, 0.05) 0%,
      rgba(251, 200, 81, 0.05) 100%
    );
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }

  .profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 600;
  }

  .dashboard-card {
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  .dashboard-card:hover {
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-3px);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
  }

  .stat-label {
    font-size: 0.85rem;
    color: #777;
  }

  .skill-container {
    margin-bottom: 1.5rem;
  }

  .genres-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .genre-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background-color: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .genre-item:hover {
    background-color: rgba(240, 107, 66, 0.1);
  }

  .genre-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
  }

  .genre-count {
    margin-left: auto;
    background-color: var(--primary-color);
    color: white;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
  }

  .chart-filters {
    display: flex;
    gap: 8px;
  }

  .color-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }

  .color-option {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }

  .color-option:hover,
  .color-option.selected {
    transform: scale(1.2);
    border-color: #dee2e6;
  }

  .activity-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: rgba(240, 107, 66, 0.05);
    transition: all 0.3s ease;
  }

  .activity-item:hover {
    background-color: rgba(240, 107, 66, 0.1);
  }

  .activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .activity-info {
    flex-grow: 1;
  }

  .activity-meta {
    font-size: 0.8rem;
    color: #777;
  }

  .activity-score {
    font-weight: 700;
    font-size: 1.25rem;
    color: var(--primary-color);
  }

  .song-recommendation {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  .song-recommendation:hover {
    background-color: rgba(240, 107, 66, 0.05);
    transform: translateX(5px);
  }

  .song-thumbnail {
    width: 60px;
    height: 45px;
    border-radius: 5px;
    overflow: hidden;
    margin-right: 12px;
    background-color: #eee;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .song-info {
    flex-grow: 1;
  }

  .song-difficulty {
    margin-left: auto;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
  }

  .song-difficulty.easy {
    background-color: #4ade80;
    color: white;
  }

  .song-difficulty.medium {
    background-color: #facc15;
    color: white;
  }

  .song-difficulty.hard {
    background-color: #f87171;
    color: white;
  }

  .achievements-container {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 5px;
  }

  .achievement-item {
    min-width: 120px;
    text-align: center;
    padding: 15px;
    border-radius: 10px;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
  }

  .achievement-item:hover {
    transform: translateY(-5px);
  }

  .achievement-icon {
    width: 50px;
    height: 50px;
    margin: 0 auto 10px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .achievement-locked {
    opacity: 0.5;
    filter: grayscale(1);
  }

  .achievements-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .achievements-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 576px) {
    .chart-filters {
      flex-wrap: wrap;
    }

    .achievements-grid {
      grid-template-columns: 1fr;
    }

    .song-thumbnail {
      width: 40px;
      height: 40px;
    }
  }
</style>
{% endblock %} {% block scripts %} {{ super() }}
<!-- Include Chart.js for performance visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize feather icons
    feather.replace();

    // Load user data
    loadUserData();

    // Setup chart data
    loadPerformanceData();

    // Load achievements
    loadAchievements();

    // Set up event listeners
    setupEventListeners();
  });

  let performanceData = [];
  let performanceChart = null;
  let chartFiltersInitialized = false;

  // Function to load user data
  async function loadUserData() {
    try {
      const response = await fetch("/api/user/profile");
      if (!response.ok) {
        throw new Error("Failed to load user profile data");
      }

      const userData = await response.json();

      // Update UI with user data
      updateStatsDisplay(userData.stats);
      updateSkillsDisplay(userData.skills);
      updateGenresDisplay(userData.favoriteGenres);
      updateActivityDisplay(userData.recentActivity);
      updateRecommendationsDisplay(userData.recommendations);
    } catch (error) {
      console.error("Error loading user data:", error);
    }
  }

  async function loadPerformanceData() {
    try {
      const response = await fetch("/api/user/improvement");
      if (!response.ok) {
        throw new Error("Failed to load performance data");
      }

      const data = await response.json();
      performanceData = Array.isArray(data) ? data : [];
      setupPerformanceChart(performanceData);
    } catch (error) {
      console.error("Error loading performance data:", error);
      setupPerformanceChart([]);
    }
  }

  // Update statistics display
  function updateStatsDisplay(stats) {
    document.getElementById("totalSessions").textContent =
      stats.totalSessions;
    document.getElementById("totalSongs").textContent = stats.totalSongs;
    document.getElementById("highestScore").textContent =
      stats.highestScore;
    document.getElementById("averageScore").textContent =
      stats.averageScore;
    document.getElementById("ranking").textContent =
      stats.ranking ? "#" + stats.ranking : "—";
    document.getElementById("improvementRate").textContent =
      stats.improvementRate + "%";

    // Animate the counters
    animateCounters();
  }

  // Update skills display
  function updateSkillsDisplay(skills) {
    // Update pitch accuracy
    document.getElementById("pitchAccuracy").textContent =
      skills.pitchAccuracy + "%";
    document.getElementById("pitchAccuracyBar").style.width =
      skills.pitchAccuracy + "%";

    // Update rhythm accuracy
    document.getElementById("rhythmAccuracy").textContent =
      skills.rhythmAccuracy + "%";
    document.getElementById("rhythmAccuracyBar").style.width =
      skills.rhythmAccuracy + "%";

    // Update vocal range
    document.getElementById("vocalRange").textContent = skills.vocalRange +
      "%";
    document.getElementById("vocalRangeBar").style.width =
      skills.vocalRange + "%";

    // Update song completion
    document.getElementById("songCompletion").textContent =
      skills.songCompletion + "%";
    document.getElementById("songCompletionBar").style.width =
      skills.songCompletion + "%";
  }

  // Update genres display
  function updateGenresDisplay(genres) {
    const genresContainer = document.getElementById("genresContainer");
    genresContainer.innerHTML = "";

    if (!genres || genres.length === 0) {
      genresContainer.innerHTML = `
        <div class="text-center p-3 w-100">
          <p class="text-muted mb-0">No favorite genres yet.</p>
        </div>
      `;
      return;
    }

    genres.forEach((genre) => {
      const genreItem = document.createElement("div");
      genreItem.className = "genre-item";
      genreItem.innerHTML = `
        <div class="genre-icon">
          <i data-feather="${genre.icon}"></i>
        </div>
        <div class="genre-name">${genre.name}</div>
        <div class="genre-count">${genre.count}</div>
      `;
      genresContainer.appendChild(genreItem);
    });

    // Re-initialize feather icons
    feather.replace();
  }

  // Update activity display
  function updateActivityDisplay(activities) {
    const activityContainer = document.getElementById(
      "recentActivityContainer",
    );
    activityContainer.innerHTML = "";

    if (!activities || activities.length === 0) {
      activityContainer.innerHTML = `
        <div class="text-center p-3">
          <p class="text-muted mb-3">No recent activity to show.</p>
          <a href="{{ url_for('karaoke_create') }}" class="btn btn-sm btn-primary">Start Singing</a>
        </div>
      `;
      return;
    }

    activities.forEach((activity) => {
      const activityItem = document.createElement("div");
      activityItem.className = "activity-item";
      activityItem.innerHTML = `
        <div class="activity-icon">
          <i data-feather="music"></i>
        </div>
        <div class="activity-info">
          <div class="fw-bold">${activity.song}</div>
          <div class="activity-meta">${activity.artist} • ${
        formatDate(activity.date)
      }</div>
        </div>
        <div class="activity-score">${activity.score}</div>
      `;
      activityContainer.appendChild(activityItem);
    });

    // Re-initialize feather icons
    feather.replace();
  }

  // Update recommendations display
  function updateRecommendationsDisplay(recommendations) {
    const recommendationsContainer = document.getElementById(
      "recommendationsContainer",
    );
    recommendationsContainer.innerHTML = "";

    if (recommendations.length === 0) {
      recommendationsContainer.innerHTML = `
        <div class="text-center p-3">
          <p class="text-muted">No recommendations available yet.</p>
          <p class="text-muted small">Sing more songs to get personalized recommendations.</p>
        </div>
      `;
      return;
    }

    recommendations.forEach((song) => {
      const difficultyClass = song.difficulty.toLowerCase();

      const songItem = document.createElement("div");
      songItem.className = "song-recommendation";
      songItem.innerHTML = `
        <div class="song-thumbnail">
          <i data-feather="music"></i>
        </div>
        <div class="song-info">
          <div class="fw-bold">${song.title}</div>
          <div class="text-muted small">${song.artist}</div>
        </div>
        <div class="song-difficulty ${difficultyClass}">${
        song.difficulty.charAt(0).toUpperCase() + song.difficulty.slice(1)
      }</div>
      `;
      recommendationsContainer.appendChild(songItem);
    });

    // Re-initialize feather icons
    feather.replace();
  }

  function formatLabel(dateString, period) {
    const date = new Date(dateString);
    if (Number.isNaN(date.getTime())) {
      return dateString;
    }

    if (period === "7") {
      return date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    if (period === "30") {
      return date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    if (period === "90") {
      return date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    return date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
  }

  function buildChartData(data, period) {
    const now = new Date();
    let cutoff = null;

    if (period === "7") {
      cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (period === "30") {
      cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    } else if (period === "90") {
      cutoff = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
    }

    const filtered = data.filter((entry) => {
      if (!entry.date) {
        return false;
      }
      const entryDate = new Date(entry.date);
      if (Number.isNaN(entryDate.getTime())) {
        return false;
      }
      return cutoff ? entryDate >= cutoff : true;
    });

    const labels = filtered.map((entry) => formatLabel(entry.date, period));
    const scoreData = filtered.map((entry) => entry.score);

    let avgData = [];
    if (scoreData.length > 0) {
      const avg =
        scoreData.reduce((sum, value) => sum + value, 0) / scoreData.length;
      avgData = scoreData.map(() => Math.round(avg * 10) / 10);
    }

    return { labels, scoreData, avgData };
  }

  // Setup performance chart
  function setupPerformanceChart(data) {
    const ctx = document
      .getElementById("performanceChart")
      .getContext("2d");

    const initial = buildChartData(data, "7");

    if (performanceChart) {
      performanceChart.destroy();
    }

    performanceChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: initial.labels,
        datasets: [
          {
            label: "Score",
            data: initial.scoreData,
            borderColor: "rgb(240, 107, 66)",
            backgroundColor: "rgba(240, 107, 66, 0.1)",
            tension: 0.3,
            fill: true,
          },
          {
            label: "Average",
            data: initial.avgData,
            borderColor: "rgba(125, 125, 125, 0.5)",
            backgroundColor: "rgba(125, 125, 125, 0.1)",
            tension: 0.3,
            borderDash: [5, 5],
            fill: false,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "top",
          },
          tooltip: {
            mode: "index",
            intersect: false,
          },
        },
        scales: {
          y: {
            beginAtZero: false,
            min: 0,
            max: 100,
            ticks: {
              stepSize: 10,
            },
          },
        },
      },
    });

    updateChartForPeriod("7");

    if (!chartFiltersInitialized) {
      chartFiltersInitialized = true;
      document.querySelectorAll(".chart-filters button").forEach((button) => {
        button.addEventListener("click", function () {
          document
            .querySelectorAll(".chart-filters button")
            .forEach((btn) => {
              btn.classList.remove("active");
            });

          this.classList.add("active");
          const period = this.getAttribute("data-period");
          updateChartForPeriod(period);
        });
      });
    }
  }

  // Update chart data for selected period
  function updateChartForPeriod(period) {
    if (!performanceChart) {
      return;
    }

    const updated = buildChartData(performanceData, period);
    performanceChart.data.labels = updated.labels;
    performanceChart.data.datasets[0].data = updated.scoreData;
    performanceChart.data.datasets[1].data = updated.avgData;
    performanceChart.update();

    document.getElementById("noDataMessage").style.display =
      updated.scoreData.length === 0 ? "block" : "none";
  }

  // Load achievements
  function loadAchievements() {
    // In a real app, this would be an API call
    const achievements = [
      {
        id: 1,
        name: "First Song",
        description: "Sing your first song",
        icon: "music",
        color: "#4ade80",
        unlocked: true,
      },
      {
        id: 2,
        name: "High Score",
        description: "Score over 90 points",
        icon: "award",
        color: "#facc15",
        unlocked: true,
      },
      {
        id: 3,
        name: "Perfect Pitch",
        description: "Achieve 100% pitch accuracy",
        icon: "target",
        color: "#f87171",
        unlocked: false,
      },
      {
        id: 4,
        name: "Song Master",
        description: "Sing 10 different songs",
        icon: "disc",
        color: "#8b5cf6",
        unlocked: true,
      },
      {
        id: 5,
        name: "Genre Explorer",
        description: "Sing songs from 5 different genres",
        icon: "compass",
        color: "#0ea5e9",
        unlocked: false,
      },
    ];

    // Display achievements in the container
    const achievementsContainer = document.getElementById(
      "achievementsContainer",
    );
    achievementsContainer.innerHTML = "";

    // Display only unlocked achievements in the main view
    const unlockedAchievements = achievements.filter((a) => a.unlocked);
    unlockedAchievements.forEach((achievement) => {
      achievementsContainer.appendChild(
        createAchievementElement(achievement),
      );
    });

    // Display all achievements in the modal
    const allAchievementsContainer = document.getElementById(
      "allAchievementsContainer",
    );
    allAchievementsContainer.innerHTML = "";

    achievements.forEach((achievement) => {
      allAchievementsContainer.appendChild(
        createAchievementElement(achievement, true),
      );
    });

    // Re-initialize feather icons
    feather.replace();
  }

  // Create achievement element
  function createAchievementElement(achievement, showLocked = false) {
    const achievementItem = document.createElement("div");
    achievementItem.className = "achievement-item";
    if (!achievement.unlocked && showLocked) {
      achievementItem.className += " achievement-locked";
    }
    if (!achievement.unlocked && !showLocked) {
      return document.createElement("div"); // Return empty div for locked achievements in main view
    }

    achievementItem.innerHTML = `
      <div class="achievement-icon" style="background-color: ${achievement.color}">
        <i data-feather="${achievement.icon}"></i>
      </div>
      <div class="achievement-name">${achievement.name}</div>
      <div class="achievement-desc small text-muted">${achievement.description}</div>
    `;

    return achievementItem;
  }

  // Setup event listeners
  function setupEventListeners() {
    // Save profile button
    document
      .getElementById("saveProfileBtn")
      .addEventListener("click", function () {
        const displayName = document.getElementById("displayName").value;

        // In a real app, this would be an API call to update the profile
        // For demo purposes, just show success message
        alert("Profile updated successfully!");

        // Close modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("editProfileModal"),
        );
        modal.hide();

        // Update display name in the UI
        document.querySelector(".profile-header h2").textContent =
          displayName;
      });

    // Share profile button
    document
      .getElementById("shareProfileBtn")
      .addEventListener("click", function () {
        // Generate share URL
        const shareUrl = window.location.href;

        // Check if Web Share API is available
        if (navigator.share) {
          navigator
            .share({
              title: "My Karaoke Profile",
              text: "Check out my KampongKonek Karaoke profile!",
              url: shareUrl,
            })
            .catch((error) => {
              console.error("Error sharing:", error);
            });
        } else {
          // Fallback for browsers that don't support Web Share API
          alert("Share this URL: " + shareUrl);
        }
      });

    // Color picker
    document.querySelectorAll(".color-option").forEach((option) => {
      option.addEventListener("click", function () {
        // Remove selected class from all options
        document.querySelectorAll(".color-option").forEach((opt) => {
          opt.classList.remove("selected");
        });

        // Add selected class to clicked option
        this.classList.add("selected");

        // Get color value
        const color = this.getAttribute("data-color");

        // Update profile avatar color
        document.getElementById("profileAvatar").style.backgroundColor =
          color;
      });
    });
  }

  // Animate counters for visual appeal
  function animateCounters() {
    document.querySelectorAll(".stat-value").forEach((counter) => {
      const target = parseInt(counter.textContent.replace(/[^\d]/g, ""));
      if (isNaN(target)) return;

      let count = 0;
      const duration = 1500;
      const frameDuration = 1000 / 60;
      const frames = Math.round(duration / frameDuration);
      const increment = target / frames;

      const timer = setInterval(() => {
        count += increment;
        if (count >= target) {
          counter.textContent = counter.id === "ranking"
            ? "#" + target
            : counter.id === "improvementRate"
            ? target + "%"
            : target;
          clearInterval(timer);
        } else {
          const value = Math.floor(count);
          counter.textContent = counter.id === "ranking"
            ? "#" + value
            : counter.id === "improvementRate"
            ? value + "%"
            : value;
        }
      }, frameDuration);
    });
  }

  // Format date as "X days ago"
  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
      return "Today";
    } else if (diffDays === 1) {
      return "Yesterday";
    } else if (diffDays < 7) {
      return `${diffDays} days ago`;
    } else if (diffDays < 30) {
      const weeks = Math.floor(diffDays / 7);
      return `${weeks} ${weeks === 1 ? "week" : "weeks"} ago`;
    } else {
      return date.toLocaleDateString();
    }
  }
</script>
{% endblock %}
