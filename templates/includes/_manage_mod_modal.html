<!-- Manage Moderators Modal -->
<div class="modal fade" id="manageModeratorsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Moderators</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('forum.update_moderators', forum_id=forum.id) }}">
                {{ csrf_token() }}
                <div class="modal-body">

                    <div class="mb-3">
                        <label for="mod_search" class="form-label">Add Moderators</label>
                        <div class="search-input-wrapper" onclick="document.getElementById('mod_search').focus()">
                            <span class="material-symbols-outlined search-icon">search</span>
                            <input type="text" id="mod_search" class="form-control search-input-with-icon"
                                placeholder="Search people you follow...">
                            <button class="search-clear-btn" id="clearModSearchBtn" onclick="clearModSearch(event)" style="display: none;">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        <div id="mod_search_results" class="search-results-box mt-2"></div>
                        <div class="form-text mb-2">You can only add people you follow</div>

                        <!-- Selected + existing mods shown as avatars -->
                        <div id="selected_mods" class="d-flex flex-wrap gap-2 mt-2"></div>
                    </div>

                    <input type="hidden" id="mod_ids_input" name="moderator_ids">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-symbols-outlined">save</span> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #mod_search_results.search-results-box {
        border: 3px solid var(--text-color);
        border-radius: 15px;
        background-color: transparent;
        max-height: 300px;
        overflow-y: auto;
        transition: border-color 0.3s;
    }

    #mod_search_results.search-results-box.active {
        display: block;
        border-color: var(--primary-color);
    }

    #mod_search_results .search-result-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    #mod_search_results .search-result-item:hover {
        background-color: var(--hover-on-bg-color);
    }

    .moderator-avatar {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }

    .moderator-avatar img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-color);
    }

    .moderator-avatar .remove-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 2px solid white;
    }

    .moderator-avatar:hover .remove-btn {
        display: flex;
    }
</style>

<script>
    // Pre-populate with existing moderators (excluding creator)
    let managedMods = [
        {% for m in forum.moderators %}
            {% if m.id != forum.creator_id %}
            {
                id: {{ m.id }},
                username: "{{ m.username }}",
                profilePicture: "{{ avatar_url(m.profile_picture) }}"
            }{% if not loop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    ];

    function renderManagedMods() {
        const container = document.getElementById('selected_mods');
        container.innerHTML = managedMods.map(mod => `
            <div class="moderator-avatar" title="${mod.username}">
                <img src="${mod.profilePicture}" alt="${mod.username}">
                <div class="remove-btn" onclick="removeManageMod(${mod.id})">
                    <span class="material-symbols-outlined" style="font-size: 16px;">close</span>
                </div>
            </div>
        `).join('');
        document.getElementById('mod_ids_input').value = managedMods.map(m => m.id).join(',');
    }

    function removeManageMod(id) {
        managedMods = managedMods.filter(m => m.id !== id);
        renderManagedMods();
    }

    function addManageMod(id, username, profilePicture) {
        if (managedMods.find(m => m.id === id) || id === {{ forum.creator_id }}) return;
        managedMods.push({ id, username, profilePicture });
        renderManagedMods();
        // Clear search
        document.getElementById('mod_search').value = '';
        document.getElementById('mod_search_results').innerHTML = '';
        document.getElementById('mod_search_results').classList.remove('active');
        document.getElementById('clearModSearchBtn').style.display = 'none';
    }

    // Initialise on load
    renderManagedMods();

    // Search
    let modSearchTimeout;
    const modSearchInput = document.getElementById('mod_search');
    const modResultsBox = document.getElementById('mod_search_results');
    const clearModSearchBtn = document.getElementById('clearModSearchBtn');

    if (modSearchInput) {
        modSearchInput.addEventListener('input', function() {
            clearTimeout(modSearchTimeout);
            const query = this.value.trim();
            clearModSearchBtn.style.display = query.length > 0 ? 'flex' : 'none';

            if (query.length < 1) {
                modResultsBox.innerHTML = '';
                modResultsBox.classList.remove('active');
                return;
            }

            modSearchTimeout = setTimeout(() => {
                fetch(`/api/search-following?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(users => {
                        if (users.length === 0) {
                            modResultsBox.innerHTML = '<p class="text-muted small px-3 py-2">No results found</p>';
                        } else {
                            modResultsBox.innerHTML = users
                                .filter(u => !managedMods.find(m => m.id === u.id) && u.id !== {{ forum.creator_id }})
                                .map(user => `
                                    <div class="search-result-item d-flex align-items-center"
                                        onclick="addManageMod(${user.id}, '${user.username}', '${user.profile_picture}')">
                                        <img src="${user.profile_picture}" class="rounded-circle me-2"
                                            style="width: 40px; height: 40px; object-fit: cover;">
                                        <div>
                                            <strong>${user.username}</strong>
                                            <span class="age-badge ms-1">${user.age_group ? user.age_group.charAt(0).toUpperCase() + user.age_group.slice(1) : user.age + ' years'}</span>
                                        </div>
                                    </div>
                                `).join('');
                        }
                        modResultsBox.classList.add('active');
                    });
            }, 300);
        });

        modSearchInput.addEventListener('focus', function() {
            if (this.value.trim().length > 0) modResultsBox.classList.add('active');
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('#manageModeratorsModal')) {
                modResultsBox.classList.remove('active');
            }
        });
    }

    function clearModSearch(event) {
        event.stopPropagation();
        modSearchInput.value = '';
        modResultsBox.innerHTML = '';
        modResultsBox.classList.remove('active');
        clearModSearchBtn.style.display = 'none';
        modSearchInput.focus();
    }
</script>