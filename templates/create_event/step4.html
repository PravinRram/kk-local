{% extends "create_event/layout.html" %}

{% block content %}
<div class="ce-progress-container">
    <a href="{{ url_for('events.events_create_type') }}" class="ce-step-circle">1</a>
    <a href="{{ url_for('events.events_create_details') }}" class="ce-step-circle">2</a>
    <a href="{{ url_for('events.events_create_image') }}" class="ce-step-circle">3</a>
    <a href="{{ url_for('events.events_create_features') }}" class="ce-step-circle active">4</a>
    <a href="{{ url_for('events.events_create_review') }}" class="ce-step-circle">5</a>
</div>

<h2 class="ce-title">Enable Features</h2>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="alert alert-danger mb-4">{{ messages[0] }}</div>
  {% endif %}
{% endwith %}

<form method="POST" id="featuresForm">
    <div class="row g-4 justify-content-center">
        <div class="col-md-6">
            <label class="ce-option-card {% if new_event.enable_group_chat %}selected{% endif %}" for="featChat">
                <input type="checkbox" name="enable_group_chat" id="featChat" value="1" class="d-none" onchange="toggleSelection(this)" {% if new_event.enable_group_chat %}checked{% endif %}>
                <i class="bi bi-chat-dots ce-option-icon"></i>
                <div class="fw-bold">Group Chat Room</div>
                <div class="small text-muted">Allow participants to chat before the event</div>
            </label>
        </div>
        <div class="col-md-6">
            <label class="ce-option-card {% if new_event.enable_minigames %}selected{% endif %}" for="featGames">
                <input type="checkbox" name="enable_minigames" id="featGames" value="1" class="d-none" onchange="toggleSelection(this)" {% if new_event.enable_minigames %}checked{% endif %}>
                <i class="bi bi-controller ce-option-icon"></i>
                <div class="fw-bold">Minigames & Karaoke</div>
                <div class="small text-muted">Enable fun activities for attendees</div>
            </label>
        </div>
    </div>

    <div class="d-flex gap-3 mt-5">
        <a href="{{ url_for('events.events_create_image') }}" class="btn ce-btn-back">Back</a>
        <button type="button" onclick="handleNext()" class="btn ce-btn-next flex-grow-1">Next</button>
    </div>
</form>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">No Features Selected</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-4">
        Are you sure you want to proceed with no features enabled?
      </div>
      <div class="modal-footer border-0 pt-0 justify-content-center gap-3">
        <button type="button" class="btn ce-btn-modal-cancel rounded-pill px-5" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn ce-btn-next rounded-pill px-5" onclick="proceedToNext()">Yes, Proceed</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
    <div class="spinner-grow" style="width: 3rem; height: 3rem; color: #F06B42;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-3 fw-bold text-muted">Finalizing details...</div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Remove localStorage logic as we use server-side session now
    
    // Modal logic
    let confirmModal;
    document.addEventListener('DOMContentLoaded', () => {
        confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    });

    function toggleSelection(el) {
        if (el.checked) {
            el.parentElement.classList.add('selected');
        } else {
            el.parentElement.classList.remove('selected');
        }
    }

    function handleNext() {
        const chat = document.getElementById('featChat');
        const games = document.getElementById('featGames');
        
        // If nothing selected, ask for confirmation
        if (!chat.checked && !games.checked) {
            confirmModal.show();
            return;
        }
        
        // Submit form
        showLoading();
        document.getElementById('featuresForm').submit();
    }

    function proceedToNext() {
        confirmModal.hide();
        showLoading(); // Show loading immediately
        document.getElementById('featuresForm').submit();
    }
    
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }
</script>
{% endblock %}
